---
title: "R 套件：DataTaipei"
author: "Wush Wu, John Chen and Will Chang"
date: "2015年5月23日"
output: 
  ioslides_presentation:
    widescreen: yes
#subtitle: shiny
#runtime: shiny
---

## R 是資料分析最常用的工具之一

<center>![](http://www.kdnuggets.com/images/r-python-other-switch.jpg)</center>

出處：<http://www.kdnuggets.com/2015/05/r-vs-python-meetup-report.html>

## R 有許多資料相關功能跟套件

```{r, echo=FALSE, warning=FALSE}
library(ggplot2)
df <- data.frame(
  date = as.Date(c("2007-04-12", "2009-10-04", "2011-05-12", "2012-08-23", "2013-11-08", "2014-10-29")),
  pkgs = 1:6 * 1000
  )
ggplot(df, aes(x = date, y = pkgs)) +
  geom_point() +
  geom_line()
```
資料來源：<http://www.r-bloggers.com/milestone-6000-packages-on-cran/>

## 我們聯結R 和DataTaipei

<center><img src="img/dataTaipei_R.png" style="max-height:100%;max-width: 100%;"/></center>

## 10行內就可搜資料、整理、做應用雛形

```{r echo=TRUE, eval = FALSE, cache=TRUE}
# 抓資料
library(DataTaipei)
rs <- dataSetMetadataSearch(q = "公廁")
data <- resourceAquire(getResources(rs, 1)$resourceId)
# 畫圖
library(ggmap)
qmap("台北火車站", zoom = 16,legend = "topleft") +
  geom_point(aes(x = lng, y = lat), colour = "blue", data = data)
```

## 臺北市公廁分佈

```{r toilet, echo=FALSE, eval = TRUE, warning=FALSE, results='hide', cache=TRUE}
# 抓資料
library(DataTaipei)
rs <- dataSetMetadataSearch(q = "公廁")
data <- resourceAquire(getResources(rs, 1)$resourceId)
# 畫圖
library(ggmap)
suppressMessages({
  qmap("台北火車站", zoom = 16,legend = "topleft") +
    geom_point(aes(x = lng, y = lat), colour = "blue", data = data)
})
```

## 再來一個例子

```{r, echo=TRUE, eval = FALSE, warning=FALSE, results='hide'}
# 抓資料
library(DataTaipei)
rs <- dataSetMetadataSearch(q = "youbike")
data <- resourceAquire(getResources(rs, 1)$resourceId)
# 整理資料
library(dplyr)
data <- dplyr::mutate(data, lat = as.numeric(lat), lng = as.numeric(lng))
# 畫圖
library(ggmap)
qmap("台北火車站", zoom = 15,legend = "topleft") +
  geom_point(aes(x = lng, y = lat, size = bemp), colour = "blue", data = data)
```

## 臺北市Youbike站點

```{r youbike, echo=FALSE, eval = TRUE, warning=FALSE, results='hide', cache=TRUE}
# 抓資料
suppressPackageStartupMessages({
  library(DataTaipei)
  library(dplyr)
  library(ggmap)
})
rs <- dataSetMetadataSearch(q = "youbike")
data <- resourceAquire(getResources(rs, 1)$resourceId)
# 整理資料
data <- dplyr::mutate(data, lat = as.numeric(lat), lng = as.numeric(lng))
# 畫圖
suppressMessages({
  qmap("台北火車站", zoom = 15,legend = "topleft") +
    geom_point(aes(x = lng, y = lat, size = bemp), colour = "blue", data = data)
})
```

## 時間序列

```{r, echo=TRUE, eval = FALSE, warning=FALSE, results='asis', cache=FALSE}
library(DataTaipei)
rs <- dataSetMetadataSearch("氣象")
data <- resourceAquire(getResources(rs, 2)$resourceId[1])
library(dplyr)
data <- dplyr::filter(data, locationName == "臺北市") %>%
  dplyr::mutate(startTime = as.POSIXct(strptime(startTime, "%Y-%m-%dT%H:%M:%S+08:00")), 氣溫=parameterName2) %>%
  dplyr::select(startTime, 氣溫)
library(dygraphs)
library(xts)
xts(data[,-1,with=FALSE], order.by = data$startTime) %>%
  dygraph
```

## 氣溫資料

```{r weather, echo=FALSE, eval = TRUE, warning=FALSE, results='asis', cache=FALSE}
suppressPackageStartupMessages({
  library(DataTaipei)
  library(dplyr)
  library(dygraphs)
  library(xts)
})
rs <- dataSetMetadataSearch("氣象")
data <- resourceAquire(getResources(rs, 2)$resourceId[1])
data <- dplyr::filter(data, locationName == "臺北市") %>%
  dplyr::mutate(startTime = as.POSIXct(strptime(startTime, "%Y-%m-%dT%H:%M:%S+08:00")), 氣溫=parameterName2) %>%
  dplyr::select(startTime, 氣溫)
xts(data[,-1,with=FALSE], order.by = data$startTime) %>%
  dygraph
```

## 資料統計

```{r, echo=TRUE, eval = FALSE, warning=FALSE, results='hide'}
# 抓資料
library(DataTaipei)
rs <- dataSetMetadataSearch(q = "不動產")
data <- resourceAquire(getResources(rs, 4)$resourceId)
# 整理資料
library(dplyr)
data <- dplyr::mutate(data, `SDATE`=as.Date(as.character(SDATE + 19110000),"%Y%m%d"))
colnames(data)[-1] <- strsplit(rs$fieldDescription[4], "、", useBytes = TRUE)[[1]]
# 行政區分佈
library(googleVis)
group_by(data, `都市土地使用分區(LANDA_Z)`) %>%
  summarise(count = length(`_id`)) %>%
  gvisBarChart(yvar = "count") %>% 
  plot
```

## 台北市不動產交易資料

```{r estate, echo=FALSE, eval = TRUE, warning=FALSE, results='asis', cache=TRUE}
suppressPackageStartupMessages({
  library(DataTaipei)
  library(dplyr)
  library(googleVis)
})
op <- options(gvis.plot.tag='chart')
rs <- dataSetMetadataSearch(q = "不動產")
data <- resourceAquire(getResources(rs, 4)$resourceId)
# 整理資料
data <- dplyr::mutate(data, `SDATE`=as.Date(as.character(SDATE + 19110000),"%Y%m%d"))
colnames(data)[-1] <- strsplit(rs$fieldDescription[4], "、", useBytes = TRUE)[[1]]
# 行政區分佈
group_by(data, `都市土地使用分區(LANDA_Z)`) %>%
  summarise(count = length(`_id`)) %>%
  gvisBarChart(yvar = "count")
```

## 分析

```{r, echo=TRUE, eval = FALSE, warning=FALSE, results='asis', cache=TRUE, dependson="estate"}
m <- dplyr::filter(data, `成交案件類型(CASE_T)` == "買賣") %>%
  lm(formula = `交易單價(萬元/坪)/租賃單價(元/坪)(UPRICE)` ~
     `單價是否含車位(UPNOTE)` +
     `主要建材(MBUILD)` +
     `行政區(DISTRICT)` +
     `都市土地使用分區(LANDA_Z)`)
```


## 影響價格的因素

```{r, echo=FALSE, eval = TRUE, warning=FALSE, results='asis', cache=TRUE, dependson="estate"}
suppressPackageStartupMessages({
  library(data.table)
  library(dplyr)
  library(xtable)
})
m <- dplyr::filter(data, `成交案件類型(CASE_T)` == "買賣") %>%
  lm(formula = `交易單價(萬元/坪)/租賃單價(元/坪)(UPRICE)` ~
     `單價是否含車位(UPNOTE)` +
     `主要建材(MBUILD)` +
     `行政區(DISTRICT)` +
     `都市土地使用分區(LANDA_Z)`)
print.xtable(xtable(m), type = "html")
```

## 但是有時候仍然有500

```{r, echo = TRUE, eval = TRUE}
library(DataTaipei)
rs <- dataSetMetadataSearch(q = "不動產")
tryCatch({
  data <- resourceAquire(getResources(rs, 1)$resourceId)
}, error= function(e) print(e))
```

## 群眾壞資料篩選 {.vcenter}

我們**正在考慮**當下載錯誤時

讓使用者自動輸入抱怨資訊

然後發送e-mail給台北市資訊局

## 我們的專案首頁

<http://github.com/TaipeiRHackers/DataTaipei>

安裝：

```r
library(devtools)
install_github("TaipeiRHackers/DataTaipei")
```

## 範例

[DataTaipei應用範例 - 台北市youbike站點資料](http://taipeirhackers.github.io/DataTaipei/youbike.html)

[DataTaipei應用範例 - 台北市天氣資料](http://taipeirhackers.github.io/DataTaipei/weather.html)

[DataTaipei應用範例 - 台北市不動產資料](http://taipeirhackers.github.io/DataTaipei/estate.html)
